"use strict";(self["webpackChunkbook"]=self["webpackChunkbook"]||[]).push([[491],{9491:function(e,t,a){a.r(t),a.d(t,{default:function(){return k}});var r=a(6768),l=a(4232);const o={class:"home",style:{padding:"10px"}},i={style:{margin:"10px 0"}},s={style:{margin:"10px 0"}},n={class:"dialog-footer"};function d(e,t,a,d,u,m){const c=(0,r.g2)("search"),h=(0,r.g2)("el-icon"),b=(0,r.g2)("el-input"),g=(0,r.g2)("el-form-item"),k=(0,r.g2)("el-button"),p=(0,r.g2)("el-form"),f=(0,r.g2)("el-table-column"),_=(0,r.g2)("el-tag"),y=(0,r.g2)("el-popconfirm"),F=(0,r.g2)("el-table"),w=(0,r.g2)("el-pagination"),V=(0,r.g2)("el-radio"),v=(0,r.g2)("el-radio-group"),C=(0,r.g2)("el-dialog");return(0,r.uX)(),(0,r.CE)("div",o,[(0,r.Lk)("div",i,[(0,r.bF)(p,{inline:"true",size:"small"},{default:(0,r.k6)(()=>[(0,r.bF)(g,{label:"图书编号"},{default:(0,r.k6)(()=>[(0,r.bF)(b,{modelValue:u.search1,"onUpdate:modelValue":t[0]||(t[0]=e=>u.search1=e),placeholder:"请输入图书编号",clearable:""},{prefix:(0,r.k6)(()=>[(0,r.bF)(h,{class:"el-input__icon"},{default:(0,r.k6)(()=>[(0,r.bF)(c)]),_:1})]),_:1},8,["modelValue"])]),_:1}),(0,r.bF)(g,{label:"图书名称"},{default:(0,r.k6)(()=>[(0,r.bF)(b,{modelValue:u.search2,"onUpdate:modelValue":t[1]||(t[1]=e=>u.search2=e),placeholder:"请输入图书名称",clearable:""},{prefix:(0,r.k6)(()=>[(0,r.bF)(h,{class:"el-input__icon"},{default:(0,r.k6)(()=>[(0,r.bF)(c)]),_:1})]),_:1},8,["modelValue"])]),_:1}),1==u.user.role?((0,r.uX)(),(0,r.Wv)(g,{key:0,label:"借阅者"},{default:(0,r.k6)(()=>[(0,r.bF)(b,{modelValue:u.search3,"onUpdate:modelValue":t[2]||(t[2]=e=>u.search3=e),placeholder:"请输入借阅者昵称",clearable:""},{prefix:(0,r.k6)(()=>[(0,r.bF)(h,{class:"el-input__icon"},{default:(0,r.k6)(()=>[(0,r.bF)(c)]),_:1})]),_:1},8,["modelValue"])]),_:1})):(0,r.Q3)("",!0),(0,r.bF)(g,null,{default:(0,r.k6)(()=>[(0,r.bF)(k,{type:"primary",style:{"margin-left":"1%"},onClick:m.load,size:"mini"},{default:(0,r.k6)(()=>[...t[13]||(t[13]=[(0,r.eW)("查询",-1)])]),_:1},8,["onClick"])]),_:1}),(0,r.bF)(g,null,{default:(0,r.k6)(()=>[(0,r.bF)(k,{size:"mini",type:"danger",onClick:m.clear},{default:(0,r.k6)(()=>[...t[14]||(t[14]=[(0,r.eW)("重置",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),(0,r.bF)(F,{data:u.tableData,stripe:"",border:"true",onSelectionChange:m.handleSelectionChange},{default:(0,r.k6)(()=>[1==u.user.role?((0,r.uX)(),(0,r.Wv)(f,{key:0,type:"selection",width:"55"})):(0,r.Q3)("",!0),(0,r.bF)(f,{prop:"isbn",label:"图书编号",sortable:""}),(0,r.bF)(f,{prop:"bookName",label:"图书名称"}),(0,r.bF)(f,{prop:"nickName",label:"借阅者"}),(0,r.bF)(f,{prop:"lendtime",label:"借出时间"}),(0,r.bF)(f,{prop:"deadtime",label:"应归还时间"}),(0,r.bF)(f,{prop:"returnTime",label:"实际还书时间"}),(0,r.bF)(f,{label:"可借数量"},{default:(0,r.k6)(e=>[(0,r.Lk)("span",null,(0,l.v_)(e.row.availableQty??e.row.available_qty??"-"),1)]),_:1}),(0,r.bF)(f,{prop:"status",label:"借阅状态"},{default:(0,r.k6)(e=>[0==e.row.status?((0,r.uX)(),(0,r.Wv)(_,{key:0,type:"warning"},{default:(0,r.k6)(()=>[...t[15]||(t[15]=[(0,r.eW)("在借",-1)])]),_:1})):1==e.row.status?((0,r.uX)(),(0,r.Wv)(_,{key:1,type:"success"},{default:(0,r.k6)(()=>[...t[16]||(t[16]=[(0,r.eW)("已还",-1)])]),_:1})):2==e.row.status?((0,r.uX)(),(0,r.Wv)(_,{key:2,type:"danger"},{default:(0,r.k6)(()=>[...t[17]||(t[17]=[(0,r.eW)("逾期",-1)])]),_:1})):((0,r.uX)(),(0,r.Wv)(_,{key:3,type:"info"},{default:(0,r.k6)(()=>[...t[18]||(t[18]=[(0,r.eW)("未知",-1)])]),_:1}))]),_:1}),(0,r.bF)(f,{fixed:"right",label:"操作"},{default:(0,r.k6)(e=>[(0,r.bF)(k,{size:"mini",onClick:t=>m.handleEdit(e.row)},{default:(0,r.k6)(()=>[...t[19]||(t[19]=[(0,r.eW)("修改",-1)])]),_:1},8,["onClick"]),1==u.user.role&&1==e.row.status?((0,r.uX)(),(0,r.Wv)(y,{key:0,title:"确认撤销还书？",onConfirm:t=>m.handleUndoReturn(e.row)},{reference:(0,r.k6)(()=>[(0,r.bF)(k,{type:"warning",size:"mini"},{default:(0,r.k6)(()=>[...t[20]||(t[20]=[(0,r.eW)("撤销还书",-1)])]),_:1})]),_:1},8,["onConfirm"])):(0,r.Q3)("",!0),(0,r.bF)(y,{title:"确认删除?",onConfirm:t=>m.handleDelete(e.row)},{reference:(0,r.k6)(()=>[(0,r.bF)(k,{type:"danger",size:"mini"},{default:(0,r.k6)(()=>[...t[21]||(t[21]=[(0,r.eW)("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data","onSelectionChange"]),(0,r.Lk)("div",s,[(0,r.bF)(w,{currentPage:u.currentPage,"onUpdate:currentPage":t[3]||(t[3]=e=>u.currentPage=e),"page-sizes":[5,10,20],"page-size":u.pageSize,layout:"total, sizes, prev, pager, next, jumper",total:u.total,onSizeChange:m.handleSizeChange,onCurrentChange:m.handleCurrentChange},null,8,["currentPage","page-size","total","onSizeChange","onCurrentChange"]),(0,r.bF)(C,{modelValue:u.dialogVisible2,"onUpdate:modelValue":t[12]||(t[12]=e=>u.dialogVisible2=e),title:"修改借阅信息",width:"30%"},{footer:(0,r.k6)(()=>[(0,r.Lk)("span",n,[(0,r.bF)(k,{onClick:t[11]||(t[11]=e=>u.dialogVisible2=!1)},{default:(0,r.k6)(()=>[...t[24]||(t[24]=[(0,r.eW)("取 消",-1)])]),_:1}),(0,r.bF)(k,{type:"primary",onClick:m.save},{default:(0,r.k6)(()=>[...t[25]||(t[25]=[(0,r.eW)("确 定",-1)])]),_:1},8,["onClick"])])]),default:(0,r.k6)(()=>[(0,r.bF)(p,{model:u.form,"label-width":"120px"},{default:(0,r.k6)(()=>[(0,r.bF)(g,{label:"图书编号"},{default:(0,r.k6)(()=>[(0,r.bF)(b,{style:{width:"80%"},modelValue:u.form.isbn,"onUpdate:modelValue":t[4]||(t[4]=e=>u.form.isbn=e)},null,8,["modelValue"])]),_:1}),(0,r.bF)(g,{label:"图书名称"},{default:(0,r.k6)(()=>[(0,r.bF)(b,{style:{width:"80%"},modelValue:u.form.bookName,"onUpdate:modelValue":t[5]||(t[5]=e=>u.form.bookName=e)},null,8,["modelValue"])]),_:1}),(0,r.bF)(g,{label:"借阅者"},{default:(0,r.k6)(()=>[(0,r.bF)(b,{style:{width:"80%"},modelValue:u.form.nickName,"onUpdate:modelValue":t[6]||(t[6]=e=>u.form.nickName=e)},null,8,["modelValue"])]),_:1}),(0,r.bF)(g,{label:"借出时间"},{default:(0,r.k6)(()=>[(0,r.bF)(b,{style:{width:"80%"},modelValue:u.form.lendtime,"onUpdate:modelValue":t[7]||(t[7]=e=>u.form.lendtime=e)},null,8,["modelValue"])]),_:1}),(0,r.bF)(g,{label:"应归还时间"},{default:(0,r.k6)(()=>[(0,r.bF)(b,{style:{width:"80%"},modelValue:u.form.deadtime,"onUpdate:modelValue":t[8]||(t[8]=e=>u.form.deadtime=e)},null,8,["modelValue"])]),_:1}),(0,r.bF)(g,{label:"实际还书时间"},{default:(0,r.k6)(()=>[(0,r.bF)(b,{style:{width:"80%"},modelValue:u.form.returnTime,"onUpdate:modelValue":t[9]||(t[9]=e=>u.form.returnTime=e)},null,8,["modelValue"])]),_:1}),(0,r.bF)(g,{label:"借阅状态"},{default:(0,r.k6)(()=>[(0,r.bF)(v,{modelValue:u.form.status,"onUpdate:modelValue":t[10]||(t[10]=e=>u.form.status=e),modelModifiers:{number:!0},onChange:m.onStatusChange},{default:(0,r.k6)(()=>[(0,r.bF)(V,{label:0},{default:(0,r.k6)(()=>[...t[22]||(t[22]=[(0,r.eW)("在借",-1)])]),_:1}),(0,r.bF)(V,{label:1},{default:(0,r.k6)(()=>[...t[23]||(t[23]=[(0,r.eW)("已还",-1)])]),_:1})]),_:1},8,["modelValue","onChange"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])])}a(8111),a(2489),a(7588),a(1701),a(3110),a(8335);var u=a(5067),m=a(1219);const c=[{id:1,isbn:"978730000001",bookName:"Java 从入门到放弃",nickName:"张三",lendtime:"2025-01-01 10:00:00",deadtime:"2025-02-01 10:00:00",returnTime:"",status:0,prolong:1},{id:2,isbn:"978730000002",bookName:"Vue3 实战指南",nickName:"李四",lendtime:"2025-01-10 15:30:00",deadtime:"2025-02-09 15:30:00",returnTime:"2025-02-05 10:00:00",status:1,prolong:0},{id:3,isbn:"978730000003",bookName:"数据库系统概论",nickName:"王五",lendtime:"2024-12-20 09:00:00",deadtime:"2025-01-19 09:00:00",returnTime:"",status:0,prolong:2}];var h={async created(){const e=localStorage.getItem("user")||sessionStorage.getItem("user")||"{}";this.user=JSON.parse(e),void 0!==this.user.role&&null!==this.user.role&&(this.user.role=Number(this.user.role));try{const{isUserInBlacklist:e}=await a.e(406).then(a.bind(a,5406)),t=await e(this.user.id);if(t)return this.isBlacklisted=!0,void this.$nextTick(()=>{m.nk.error("您已被列入黑名单，无法进行借书相关操作！")})}catch(t){this.isBlacklisted=!1}this.load()},name:"BorrowManageView",methods:{handleSelectionChange(e){this.forms=e},deleteBatch(){this.forms.length?m.nk.warning("批量删除功能暂不支持，请逐条删除"):m.nk.warning("请选择数据！")},load(){if(this.useMock){let e=c.filter(e=>{const t=!this.search1||String(e.isbn).includes(this.search1),a=!this.search2||(e.bookName||"").includes(this.search2),r=!this.search3||(e.nickName||"").includes(this.search3);return t&&a&&r});this.total=e.length;const t=(this.currentPage-1)*this.pageSize,a=t+this.pageSize;return void(this.tableData=e.slice(t,a))}u.A.get("/borrow/records",{params:{page:this.currentPage,pageSize:this.pageSize}}).then(e=>{console.log("借阅记录:",e);const t=e.data||{};let a=Array.isArray(t.rows)?t.rows:Array.isArray(t.records)?t.records:[];Promise.all([u.A.get("/books",{params:{page:1,pageSize:1e4}}),u.A.get("/users",{params:{page:1,pageSize:1e4}})]).then(([e,r])=>{const l=Array.isArray(e.data)?e.data:e.data?.records||e.data?.rows||[],o=Array.isArray(r.data)?r.data:r.data?.records||r.data?.rows||[],i={},s={},n={};l.forEach(e=>{i[e.id]=e.title||e.name||e.bookTitle||"";let t=null;Object.prototype.hasOwnProperty.call(e,"available_qty")&&(t=e.available_qty),null==t&&Object.prototype.hasOwnProperty.call(e,"availableQty")&&(t=e.availableQty),null==t&&Object.prototype.hasOwnProperty.call(e,"availableqty")&&(t=e.availableqty),s[e.id]=t}),o.forEach(e=>{n[e.id]=e.userName||e.username||e.nickName||""});const d=a.map(e=>({id:e.id,isbn:e.book_id||e.bookId||"",bookName:e.book_name||e.bookTitle||i[e.book_id||e.bookId]||"",nickName:e.user_name||e.userName||n[e.user_id||e.userId]||e.user_id||e.userId||"",lendtime:e.borrow_date||e.borrowDate?String(e.borrow_date||e.borrowDate).split("T").join(" ").substring(0,19):"",deadtime:e.due_date||e.dueDate?String(e.due_date||e.dueDate).split("T").join(" ").substring(0,19):"",returnTime:e.return_time||e.return_date||e.returnDate||e.returnTime?String(e.return_time||e.return_date||e.returnDate||e.returnTime).split("T").join(" ").substring(0,19):"",availableQty:s[e.book_id||e.bookId]??null,status:null!=e.status?Number(e.status):0})),u=d.filter(e=>{const t=!this.search1||String(e.isbn).includes(this.search1),a=!this.search2||(e.bookName||"").includes(this.search2),r=!this.search3||(e.nickName||"").includes(this.search3);return t&&a&&r});this.tableData=u,this.total=t.total||u.length}).catch(e=>{console.error("加载书籍/用户数据失败:",e),m.nk.error("加载数据失败，请稍后重试")})}).catch(e=>{console.error("查询借阅记录失败:",e),m.nk.error("查询借阅记录失败，请稍后重试"),this.tableData=[],this.total=0})},clear(){this.search1="",this.search2="",this.search3="",this.load()},handleDelete(e){e.id?u.A.get("/borrow/delete/"+e.id).then(e=>{console.log(e),1===e.code||0===e.code?(m.nk.success(e.msg||"删除成功"),this.load()):m.nk.error(e.msg||"删除失败")}).catch(e=>{console.error("删除失败:",e),m.nk.error("删除失败，请稍后重试")}):m.nk.error("记录ID异常")},getRemainingBorrow(e){if(this.useMock){const t=c.filter(t=>t.nickName===e&&0===t.status).length;return Math.max(0,5-t)}return"-"},save(){if(this.useMock){if(this.form.id){const e=c.findIndex(e=>e.id===this.form.id);-1!==e?(c.splice(e,1,{...c[e],...this.form}),m.nk.success("修改信息成功（本地模拟）")):m.nk.error("未找到该记录（本地模拟）")}return this.load(),void(this.dialogVisible2=!1)}if(this.isBlacklisted)return void m.nk.error("您已被列入黑名单，无法借书！");if(!this.form.id)return void m.nk.error("记录ID异常");const e=e=>{if(!e)return"";const t=String(e).trim().replace(" ","T");return t.substring(0,19)},t=e=>{if(!e)return"";const t=String(e).trim().replace("T"," ");return t.substring(0,19)},a=()=>{const e=e=>String(e).padStart(2,"0"),t=new Date;return`${t.getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())} ${e(t.getHours())}:${e(t.getMinutes())}:${e(t.getSeconds())}`},r={id:Number(this.form.id),status:Number(this.form.status)};this.form.deadtime&&(r.dueDate=e(this.form.deadtime)),0===Number(this.form.status)?void 0!==r.returnTime&&delete r.returnTime:this.form.returnTime?r.returnTime=t(this.form.returnTime):1===Number(this.form.status)&&(r.returnTime=a()),console.log("提交 /borrow/update payload:",r),u.A.post("/borrow/update",r).then(e=>{console.log("更新结果:",e),1===e.code?(m.nk.success(e.msg||"修改信息成功"),this.load(),this.dialogVisible2=!1):m.nk.error(e.msg||"修改信息失败")}).catch(e=>{const t=e?.response?.status,a=e?.response?.data?.msg;console.error("修改失败:",t,e?.response?.data),1!==Number(this.form.status)||404!==t&&500!==t?m.nk.error(`修改失败（HTTP ${t||""}）：${a||"请稍后重试"}`):u.A.post("/return",{borrowId:Number(this.form.id)}).then(e=>{if(1===e.code)return m.nk.success(e.msg||"已还成功（使用兜底接口）"),this.load(),void(this.dialogVisible2=!1);m.nk.error(e.msg||"还书失败")}).catch(e=>{console.error("兜底还书失败:",e),m.nk.error(`修改失败（HTTP ${t||""}）：${a||"请稍后重试"}`)})})},async handleEdit(e){this.isBlacklisted?m.nk.error("您已被列入黑名单，无法借书！"):(this.form=JSON.parse(JSON.stringify(e)),this.dialogVisible2=!0)},handleUndoReturn(e){if(!e.id)return void m.nk.error("记录ID异常");const t={id:Number(e.id),status:0};u.A.post("/borrow/update",t).then(e=>{if(1===e.code)return m.nk.success(e.msg||"已撤销还书，状态恢复在借"),void this.load();m.nk.error(e.msg||"撤销失败")}).catch(e=>{const t=e?.response?.status,a=e?.response?.data?.msg;console.error("撤销失败:",e),m.nk.error(`撤销失败（HTTP ${t||""}）：${a||"请稍后重试"}`)})},onStatusChange(e){0===Number(e)&&(this.form.returnTime="")},handleSizeChange(e){this.pageSize=e,this.load()},handleCurrentChange(e){this.currentPage=e,this.load()}},data(){return{form:{},form2:{},form3:{},dialogVisible:!1,dialogVisible2:!1,search1:"",search2:"",search3:"",total:10,currentPage:1,pageSize:10,tableData:[],user:{},forms:[],useMock:!1,isBlacklisted:!1}}},b=a(1241);const g=(0,b.A)(h,[["render",d]]);var k=g}}]);
//# sourceMappingURL=491.4d841e29.js.map