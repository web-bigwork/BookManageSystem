"use strict";(self["webpackChunkbook"]=self["webpackChunkbook"]||[]).push([[164],{7164:function(e,t,r){r.r(t),r.d(t,{default:function(){return g}});var a=r(6768);const s={class:"home",style:{padding:"10px"}},o={style:{margin:"10px 0"}},l={style:{margin:"10px 0"}};function n(e,t,r,n,i,u){const d=(0,a.g2)("search"),c=(0,a.g2)("el-icon"),h=(0,a.g2)("el-input"),b=(0,a.g2)("el-form-item"),g=(0,a.g2)("el-button"),k=(0,a.g2)("el-form"),m=(0,a.g2)("el-table-column"),p=(0,a.g2)("el-tag"),f=(0,a.g2)("el-table"),y=(0,a.g2)("el-pagination");return(0,a.uX)(),(0,a.CE)("div",s,[(0,a.Lk)("div",o,[(0,a.bF)(k,{inline:"true",size:"small"},{default:(0,a.k6)(()=>[(0,a.bF)(b,{label:"图书编号"},{default:(0,a.k6)(()=>[(0,a.bF)(h,{modelValue:i.search1,"onUpdate:modelValue":t[0]||(t[0]=e=>i.search1=e),placeholder:"请输入图书编号",clearable:""},{prefix:(0,a.k6)(()=>[(0,a.bF)(c,{class:"el-input__icon"},{default:(0,a.k6)(()=>[(0,a.bF)(d)]),_:1})]),_:1},8,["modelValue"])]),_:1}),(0,a.bF)(b,{label:"图书名称"},{default:(0,a.k6)(()=>[(0,a.bF)(h,{modelValue:i.search2,"onUpdate:modelValue":t[1]||(t[1]=e=>i.search2=e),placeholder:"请输入图书名称",clearable:""},{prefix:(0,a.k6)(()=>[(0,a.bF)(c,{class:"el-input__icon"},{default:(0,a.k6)(()=>[(0,a.bF)(d)]),_:1})]),_:1},8,["modelValue"])]),_:1}),(0,a.bF)(b,null,{default:(0,a.k6)(()=>[(0,a.bF)(g,{type:"primary",style:{"margin-left":"1%"},onClick:u.load,size:"mini"},{default:(0,a.k6)(()=>[...t[3]||(t[3]=[(0,a.eW)("查询",-1)])]),_:1},8,["onClick"])]),_:1}),(0,a.bF)(b,null,{default:(0,a.k6)(()=>[(0,a.bF)(g,{size:"mini",type:"danger",onClick:u.clear},{default:(0,a.k6)(()=>[...t[4]||(t[4]=[(0,a.eW)("重置",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),(0,a.bF)(f,{data:i.tableData,stripe:"",border:"true"},{default:(0,a.k6)(()=>[(0,a.bF)(m,{prop:"isbn",label:"图书编号",sortable:""}),(0,a.bF)(m,{prop:"bookName",label:"图书名称"}),(0,a.bF)(m,{prop:"lendtime",label:"借出时间"}),(0,a.bF)(m,{prop:"deadtime",label:"应归还时间"}),(0,a.bF)(m,{prop:"returnTime",label:"实际还书时间"}),(0,a.bF)(m,{prop:"status",label:"借阅状态"},{default:(0,a.k6)(e=>[0==e.row.status?((0,a.uX)(),(0,a.Wv)(p,{key:0,type:"warning"},{default:(0,a.k6)(()=>[...t[5]||(t[5]=[(0,a.eW)("在借",-1)])]),_:1})):1==e.row.status?((0,a.uX)(),(0,a.Wv)(p,{key:1,type:"success"},{default:(0,a.k6)(()=>[...t[6]||(t[6]=[(0,a.eW)("已还",-1)])]),_:1})):2==e.row.status?((0,a.uX)(),(0,a.Wv)(p,{key:2,type:"danger"},{default:(0,a.k6)(()=>[...t[7]||(t[7]=[(0,a.eW)("逾期",-1)])]),_:1})):((0,a.uX)(),(0,a.Wv)(p,{key:3,type:"info"},{default:(0,a.k6)(()=>[...t[8]||(t[8]=[(0,a.eW)("未知",-1)])]),_:1}))]),_:1}),(0,a.bF)(m,{fixed:"right",label:"操作"},{default:(0,a.k6)(e=>[0==e.row.status?((0,a.uX)(),(0,a.Wv)(g,{key:0,type:"primary",size:"mini",onClick:t=>u.handleRenew(e.row)},{default:(0,a.k6)(()=>[...t[9]||(t[9]=[(0,a.eW)("续借",-1)])]),_:1},8,["onClick"])):(0,a.Q3)("",!0)]),_:1})]),_:1},8,["data"]),(0,a.Lk)("div",l,[(0,a.bF)(y,{currentPage:i.currentPage,"onUpdate:currentPage":t[2]||(t[2]=e=>i.currentPage=e),"page-size":5,layout:"total, prev, pager, next, jumper",total:i.total,onCurrentChange:u.handleCurrentChange},null,8,["currentPage","total","onCurrentChange"])])])}r(8111),r(2489),r(7588),r(1701),r(8335),r(4979);var i=r(5067),u=r(1219);const d=[{id:1,isbn:"978730000001",bookName:"Java 从入门到放弃",nickName:"张三",lendtime:"2025-01-01 10:00:00",deadtime:"2025-02-01 10:00:00",returnTime:"",status:0,prolong:1},{id:2,isbn:"978730000002",bookName:"Vue3 实战指南",nickName:"李四",lendtime:"2025-01-10 15:30:00",deadtime:"2025-02-09 15:30:00",returnTime:"2025-02-05 10:00:00",status:1,prolong:0},{id:3,isbn:"978730000003",bookName:"数据库系统概论",nickName:"王五",lendtime:"2024-12-20 09:00:00",deadtime:"2025-01-19 09:00:00",returnTime:"",status:0,prolong:2}];var c={created(){const e=localStorage.getItem("user")||sessionStorage.getItem("user")||"{}";if(this.user=JSON.parse(e),void 0!==this.user.role&&null!==this.user.role&&(this.user.role=Number(this.user.role)),!this.user.id){const e=localStorage.getItem("token")||sessionStorage.getItem("token");if(e)try{const t=JSON.parse(atob(e.split(".")[1]));this.user.id=t.id||t.userId||t.sub,console.log("从 token 恢复 user.id:",this.user.id)}catch(t){console.error("解析 token 失败:",t)}}this.load()},name:"BookWithUserView",methods:{handleRenew(e){if(!e.id)return void u.nk.error("记录ID缺失，无法续借");const t={borrowId:e.id};i.A.post("/renewById",t).then(e=>{1===e.code?(u.nk.success(e.msg||"续借成功"),this.load()):u.nk.error(e.msg||"续借失败")}).catch(e=>{console.error("续借失败:",e),u.nk.error("续借失败，请稍后重试")})},load(){if(this.useMock){const e=this.user.username||this.user.nickName||"";let t=d.filter(t=>{const r=!e||t.nickName===e,a=1===t.status,s=!this.search1||String(t.isbn).includes(this.search1),o=!this.search2||(t.bookName||"").includes(this.search2);return r&&a&&s&&o});this.total=t.length;const r=(this.currentPage-1)*this.pageSize,a=r+this.pageSize;return void(this.tableData=t.slice(r,a))}this.user.id?(console.log("请求路径:",`/borrow/user/${this.user.id}/records`),i.A.get(`/borrow/user/${this.user.id}/records`,{params:{page:this.currentPage,pageSize:this.pageSize}}).then(e=>{console.log("用户借阅记录:",e);const t=e.data||{};let r=Array.isArray(t.rows)?t.rows:Array.isArray(t.records)?t.records:[];r.length>0&&(console.log("第一条记录完整数据:",r[0]),console.log("return_time:",r[0].return_time),console.log("status:",r[0].status)),i.A.get("/books").then(e=>{const a=Array.isArray(e.data)?e.data:e.data?.records||e.data?.rows||[],s={};a.forEach(e=>{s[e.id]=e.title||e.name||""});const o=r.map(e=>({id:e.id,isbn:e.bookId||e.book_id||"",bookName:e.bookTitle||s[e.bookId]||e.book_name||"",lendtime:e.borrowDate?e.borrowDate.split("T").join(" ").substring(0,19):"",deadtime:e.dueDate?e.dueDate.split("T").join(" ").substring(0,19):"",returnTime:e.returnDate?e.returnDate.split("T").join(" ").substring(0,19):"",status:null!=e.status?Number(e.status):0})),l=o.filter(e=>{const t=!this.search1||String(e.isbn).includes(this.search1),r=!this.search2||(e.bookName||"").includes(this.search2);return t&&r});this.tableData=l,this.total=t.total||l.length}).catch(e=>{console.error("加载书籍数据失败:",e),u.nk.error("加载数据失败，请稍后重试")})}).catch(e=>{console.error("查询失败:",e),console.error("请求的完整URL:",e.config?.url),console.error("错误详情:",e.response?.data),u.nk.error(`查询失败：${e.response?.status||""} ${e.response?.data?.msg||"请检查后端接口是否正确"}`),this.tableData=[],this.total=0})):u.nk.error("用户ID不存在，请重新登录")},clear(){this.search1="",this.search2="",this.load()},handleCurrentChange(e){this.currentPage=e,this.load()}},data(){return{search1:"",search2:"",total:10,currentPage:1,pageSize:5,tableData:[],user:{},useMock:!1}}},h=r(1241);const b=(0,h.A)(c,[["render",n]]);var g=b}}]);
//# sourceMappingURL=164.040c37ee.js.map