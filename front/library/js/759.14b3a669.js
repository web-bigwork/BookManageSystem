"use strict";(self["webpackChunkbook"]=self["webpackChunkbook"]||[]).push([[406,759],{4759:function(e,t,l){l.r(t),l.d(t,{default:function(){return y}});var o=l(6768);const a={class:"home",style:{padding:"10px"}},i={style:{margin:"10px 0"}},r={style:{margin:"10px 0"}},s={class:"dialog-footer"},n={style:{margin:"10px 0"}},d={class:"dialog-footer"},u={class:"dialog-footer"};function c(e,t,l,c,h,b){const m=(0,o.g2)("search"),k=(0,o.g2)("el-icon"),g=(0,o.g2)("el-input"),f=(0,o.g2)("el-form-item"),p=(0,o.g2)("svg-icon"),y=(0,o.g2)("el-button"),_=(0,o.g2)("el-popconfirm"),F=(0,o.g2)("el-form"),V=(0,o.g2)("el-table-column"),w=(0,o.g2)("el-table"),v=(0,o.g2)("el-dialog"),C=(0,o.g2)("el-pagination");return(0,o.uX)(),(0,o.CE)("div",a,[(0,o.Lk)("div",i,[(0,o.bF)(F,{inline:"true",size:"small"},{default:(0,o.k6)(()=>[(0,o.bF)(f,{label:"图书编号"},{default:(0,o.k6)(()=>[(0,o.bF)(g,{modelValue:h.search1,"onUpdate:modelValue":t[0]||(t[0]=e=>h.search1=e),placeholder:"请输入图书编号",clearable:""},{prefix:(0,o.k6)(()=>[(0,o.bF)(k,{class:"el-input__icon"},{default:(0,o.k6)(()=>[(0,o.bF)(m)]),_:1})]),_:1},8,["modelValue"])]),_:1}),(0,o.bF)(f,{label:"图书名称"},{default:(0,o.k6)(()=>[(0,o.bF)(g,{modelValue:h.search2,"onUpdate:modelValue":t[1]||(t[1]=e=>h.search2=e),placeholder:"请输入图书名称",clearable:""},{prefix:(0,o.k6)(()=>[(0,o.bF)(k,{class:"el-input__icon"},{default:(0,o.k6)(()=>[(0,o.bF)(m)]),_:1})]),_:1},8,["modelValue"])]),_:1}),(0,o.bF)(f,{label:"作者"},{default:(0,o.k6)(()=>[(0,o.bF)(g,{modelValue:h.search3,"onUpdate:modelValue":t[2]||(t[2]=e=>h.search3=e),placeholder:"请输入作者",clearable:""},{prefix:(0,o.k6)(()=>[(0,o.bF)(k,{class:"el-input__icon"},{default:(0,o.k6)(()=>[(0,o.bF)(m)]),_:1})]),_:1},8,["modelValue"])]),_:1}),(0,o.bF)(f,null,{default:(0,o.k6)(()=>[(0,o.bF)(y,{type:"primary",style:{"margin-left":"1%"},onClick:b.load,size:"mini"},{default:(0,o.k6)(()=>[(0,o.bF)(p,{iconClass:"search"}),t[16]||(t[16]=(0,o.eW)("查询",-1))]),_:1},8,["onClick"])]),_:1}),(0,o.bF)(f,null,{default:(0,o.k6)(()=>[(0,o.bF)(y,{size:"mini",type:"danger",onClick:b.clear},{default:(0,o.k6)(()=>[...t[17]||(t[17]=[(0,o.eW)("重置",-1)])]),_:1},8,["onClick"])]),_:1}),0!=h.numOfOutDataBook?((0,o.uX)(),(0,o.Wv)(f,{key:0,style:{float:"right"}},{default:(0,o.k6)(()=>[(0,o.bF)(_,{"confirm-button-text":"查看","cancel-button-text":"取消",icon:e.InfoFilled,"icon-color":"red",title:"您有图书已逾期，请尽快归还",onConfirm:b.toLook},{reference:(0,o.k6)(()=>[(0,o.bF)(y,{type:"warning"},{default:(0,o.k6)(()=>[...t[18]||(t[18]=[(0,o.eW)("逾期通知",-1)])]),_:1})]),_:1},8,["icon","onConfirm"])]),_:1})):(0,o.Q3)("",!0)]),_:1})]),(0,o.Lk)("div",r,[1===h.user.role?((0,o.uX)(),(0,o.Wv)(_,{key:0,title:"确认删除?",onConfirm:b.deleteBatch},{reference:(0,o.k6)(()=>[(0,o.bF)(y,{type:"danger",size:"mini"},{default:(0,o.k6)(()=>[...t[19]||(t[19]=[(0,o.eW)("批量删除",-1)])]),_:1})]),_:1},8,["onConfirm"])):(0,o.Q3)("",!0)]),(0,o.bF)(w,{data:h.tableData,stripe:"",border:"true",onSelectionChange:b.handleSelectionChange},{default:(0,o.k6)(()=>[1===h.user.role?((0,o.uX)(),(0,o.Wv)(V,{key:0,type:"selection",width:"55"})):(0,o.Q3)("",!0),(0,o.bF)(V,{prop:"id",label:"图书编号",sortable:""}),(0,o.bF)(V,{prop:"title",label:"书名"}),(0,o.bF)(V,{prop:"author",label:"作者"}),(0,o.bF)(V,{prop:"available_qty",label:"可借阅数量",sortable:""}),(0,o.bF)(V,{fixed:"right",label:"操作"},{default:(0,o.k6)(e=>[1===h.user.role?((0,o.uX)(),(0,o.Wv)(y,{key:0,size:"mini",onClick:t=>b.handleEdit(e.row)},{default:(0,o.k6)(()=>[...t[20]||(t[20]=[(0,o.eW)("修改",-1)])]),_:1},8,["onClick"])):(0,o.Q3)("",!0),1===h.user.role?((0,o.uX)(),(0,o.Wv)(_,{key:1,title:"确认删除?",onConfirm:t=>b.handleDelete(e.row.id)},{reference:(0,o.k6)(()=>[(0,o.bF)(y,{type:"danger",size:"mini"},{default:(0,o.k6)(()=>[...t[21]||(t[21]=[(0,o.eW)("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])):(0,o.Q3)("",!0),0==h.user.role?((0,o.uX)(),(0,o.Wv)(y,{key:2,size:"mini",onClick:t=>b.handlelend(e.row.id),disabled:e.row.hasBorrowed},{default:(0,o.k6)(()=>[...t[22]||(t[22]=[(0,o.eW)("借阅",-1)])]),_:1},8,["onClick","disabled"])):(0,o.Q3)("",!0),0==h.user.role?((0,o.uX)(),(0,o.Wv)(_,{key:3,title:"确认还书?",onConfirm:t=>b.handlereturn(e.row.borrowId)},{reference:(0,o.k6)(()=>[(0,o.bF)(y,{type:"danger",size:"mini",disabled:!e.row.borrowId},{default:(0,o.k6)(()=>[...t[23]||(t[23]=[(0,o.eW)("还书",-1)])]),_:1},8,["disabled"])]),_:2},1032,["onConfirm"])):(0,o.Q3)("",!0)]),_:1})]),_:1},8,["data","onSelectionChange"]),0!=h.numOfOutDataBook?((0,o.uX)(),(0,o.Wv)(v,{key:0,modelValue:h.dialogVisible3,"onUpdate:modelValue":t[4]||(t[4]=e=>h.dialogVisible3=e),title:"逾期详情",width:"50%","before-close":e.handleClose},{footer:(0,o.k6)(()=>[(0,o.Lk)("span",s,[(0,o.bF)(y,{type:"primary",onClick:t[3]||(t[3]=e=>h.dialogVisible3=!1)},{default:(0,o.k6)(()=>[...t[24]||(t[24]=[(0,o.eW)("确认",-1)])]),_:1})])]),default:(0,o.k6)(()=>[(0,o.bF)(w,{data:h.outDateBook,style:{width:"100%"}},{default:(0,o.k6)(()=>[(0,o.bF)(V,{prop:"isbn",label:"图书编号"}),(0,o.bF)(V,{prop:"bookName",label:"书名"}),(0,o.bF)(V,{prop:"lendtime",label:"借阅日期"}),(0,o.bF)(V,{prop:"deadtime",label:"截至日期"})]),_:1},8,["data"])]),_:1},8,["modelValue","before-close"])):(0,o.Q3)("",!0),(0,o.Lk)("div",n,[(0,o.bF)(C,{currentPage:h.currentPage,"onUpdate:currentPage":t[5]||(t[5]=e=>h.currentPage=e),"page-size":h.pageSize,layout:"total, prev, pager, next, jumper",total:h.total,onCurrentChange:b.handleCurrentChange},null,8,["currentPage","page-size","total","onCurrentChange"]),(0,o.bF)(v,{modelValue:h.dialogVisible,"onUpdate:modelValue":t[10]||(t[10]=e=>h.dialogVisible=e),title:"上架书籍",width:"30%"},{footer:(0,o.k6)(()=>[(0,o.Lk)("span",d,[(0,o.bF)(y,{onClick:t[9]||(t[9]=e=>h.dialogVisible=!1)},{default:(0,o.k6)(()=>[...t[25]||(t[25]=[(0,o.eW)("取 消",-1)])]),_:1}),(0,o.bF)(y,{type:"primary",onClick:b.save},{default:(0,o.k6)(()=>[...t[26]||(t[26]=[(0,o.eW)("确 定",-1)])]),_:1},8,["onClick"])])]),default:(0,o.k6)(()=>[(0,o.bF)(F,{model:h.form,"label-width":"120px"},{default:(0,o.k6)(()=>[(0,o.bF)(f,{label:"书名"},{default:(0,o.k6)(()=>[(0,o.bF)(g,{style:{width:"80%"},modelValue:h.form.title,"onUpdate:modelValue":t[6]||(t[6]=e=>h.form.title=e)},null,8,["modelValue"])]),_:1}),(0,o.bF)(f,{label:"作者"},{default:(0,o.k6)(()=>[(0,o.bF)(g,{style:{width:"80%"},modelValue:h.form.author,"onUpdate:modelValue":t[7]||(t[7]=e=>h.form.author=e)},null,8,["modelValue"])]),_:1}),(0,o.bF)(f,{label:"可借阅数量"},{default:(0,o.k6)(()=>[(0,o.bF)(g,{style:{width:"80%"},modelValue:h.form.available_qty,"onUpdate:modelValue":t[8]||(t[8]=e=>h.form.available_qty=e),modelModifiers:{number:!0},type:"number",min:"0"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),(0,o.bF)(v,{modelValue:h.dialogVisible2,"onUpdate:modelValue":t[15]||(t[15]=e=>h.dialogVisible2=e),title:"修改书籍信息",width:"30%"},{footer:(0,o.k6)(()=>[(0,o.Lk)("span",u,[(0,o.bF)(y,{onClick:t[14]||(t[14]=e=>h.dialogVisible=!1)},{default:(0,o.k6)(()=>[...t[27]||(t[27]=[(0,o.eW)("取 消",-1)])]),_:1}),(0,o.bF)(y,{type:"primary",onClick:b.save},{default:(0,o.k6)(()=>[...t[28]||(t[28]=[(0,o.eW)("确 定",-1)])]),_:1},8,["onClick"])])]),default:(0,o.k6)(()=>[(0,o.bF)(F,{model:h.form,"label-width":"120px"},{default:(0,o.k6)(()=>[(0,o.bF)(f,{label:"书名"},{default:(0,o.k6)(()=>[(0,o.bF)(g,{style:{width:"80%"},modelValue:h.form.title,"onUpdate:modelValue":t[11]||(t[11]=e=>h.form.title=e)},null,8,["modelValue"])]),_:1}),(0,o.bF)(f,{label:"作者"},{default:(0,o.k6)(()=>[(0,o.bF)(g,{style:{width:"80%"},modelValue:h.form.author,"onUpdate:modelValue":t[12]||(t[12]=e=>h.form.author=e)},null,8,["modelValue"])]),_:1}),(0,o.bF)(f,{label:"可借阅数量"},{default:(0,o.k6)(()=>[(0,o.bF)(g,{style:{width:"80%"},modelValue:h.form.available_qty,"onUpdate:modelValue":t[13]||(t[13]=e=>h.form.available_qty=e),modelModifiers:{number:!0},type:"number",min:"0"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])])}l(4114),l(8111),l(2489),l(116),l(7588),l(1701),l(3110),l(8335),l(4979);var h=l(5067),b=l(1219),m=l(5406);const k=[{id:1,title:"Java 从入门到放弃",author:"张三",available_qty:5},{id:2,title:"Vue3 实战指南",author:"李四",available_qty:2},{id:3,title:"数据库系统概论",author:"王五",available_qty:10}];var g={created(){const e=sessionStorage.getItem("user")||localStorage.getItem("user")||"{}";if(this.user=JSON.parse(e),!this.user.id){const e=sessionStorage.getItem("token")||localStorage.getItem("token");if(e)try{const t=JSON.parse(atob(e.split(".")[1]));if(t.id){this.user.id=t.id;const e=sessionStorage.getItem("user")?"sessionStorage":"localStorage";"sessionStorage"===e?sessionStorage.setItem("user",JSON.stringify(this.user)):localStorage.setItem("user",JSON.stringify(this.user)),console.log("从 token 中恢复用户 ID:",t.id)}}catch(t){console.error("解析 token 失败:",t)}}void 0!==this.user.role&&null!==this.user.role&&(this.user.role=Number(this.user.role)),console.log("User data:",this.user),console.log("User role:",this.user.role,"Type:",typeof this.user.role),this.load()},name:"BookView",methods:{handleSelectionChange(e){this.ids=e.map(e=>e.id)},deleteBatch(){if(this.ids.length)return this.useMock?(this.ids.forEach(e=>{const t=k.findIndex(t=>t.id===e);-1!==t&&k.splice(t,1)}),b.nk.success("批量删除成功（本地模拟）"),void this.load()):void Promise.all(this.ids.map(e=>h.A.get("/delById",{params:{id:e}}))).then(()=>{b.nk.success("批量删除成功"),this.load()}).catch(()=>{b.nk.error("批量删除失败")});b.nk.warning("请选择数据！")},load(){if(this.useMock){let e=k.filter(e=>{const t=!this.search1||String(e.id).includes(this.search1),l=!this.search2||(e.title||"").includes(this.search2),o=!this.search3||(e.author||"").includes(this.search3);return t&&l&&o});this.total=e.length;const t=(this.currentPage-1)*this.pageSize,l=t+this.pageSize;return void(this.tableData=e.slice(t,l))}const e={page:this.currentPage,pageSize:this.pageSize};let t="/books";this.search2&&this.search2.trim()?(t="/findByTitle",e.keyword=this.search2.trim()):this.search3&&this.search3.trim()&&(t="/findByAuthor",e.author=this.search3.trim()),h.A.get(t,{params:e}).then(e=>{let t=[];const l=e.data;Array.isArray(l)?t=l:l&&Array.isArray(l.records)?t=l.records:l&&Array.isArray(l.rows)?t=l.rows:l&&(t=l),Array.isArray(t)||(t=[]);const o=t.map(e=>({id:e.id,title:e.title||e.name||e.bookName||"",author:e.author||"",available_qty:null!=e.available_qty?e.available_qty:null!=e.borrownum?e.borrownum:0,borrownum:null!=e.borrownum?e.borrownum:0,status:"string"===typeof e.status?Number(e.status):null!=e.status?e.status:1,isbn:e.isbn||"",borrowId:e.borrowId||e.borrow_id||null}));console.log("原始数据示例:",t[0]),console.log("映射后数据示例:",o[0]);const a=o.filter(e=>{const t=!this.search1||String(e.id||"").includes(this.search1.trim()),l=!this.search2||(e.title||"").includes(this.search2.trim()),o=!this.search3||(e.author||"").includes(this.search3.trim());return t&&l&&o});this.tableData=a,this.total=l&&l.total?l.total:a.length,0===this.user.role&&this.user.id&&this.loadBorrowRecords()}).catch(e=>{console.error("查询失败:",e),b.nk.error("查询失败，请稍后重试"),this.tableData=[],this.total=0})},clear(){this.search1="",this.search2="",this.search3="",this.currentPage=1,this.$nextTick(()=>{this.load()})},loadBorrowRecords(){h.A.get("/borrowing/"+this.user.id).then(e=>{const t=e.data||[];console.log("用户正在借阅的记录:",t),this.tableData=this.tableData.map(e=>{const l=t.find(t=>(t.bookId===e.id||t.book_id===e.id)&&(0===t.status||"0"===t.status));return l?{...e,borrowId:l.id||l.borrowId,hasBorrowed:!0}:e}),console.log("匹配后的图书列表:",this.tableData)}).catch(e=>{console.error("获取借阅记录失败:",e)})},handleDelete(e){h.A.get("/delById",{params:{id:e}}).then(e=>{console.log(e),1===e.code||0===e.code?b.nk.success(e.msg||"删除成功"):b.nk.error(e.msg||"删除失败"),this.load()})},handlereturn(e){e?(console.log("还书参数:",{borrowId:e}),h.A.post("/return",{borrowId:Number(e)}).then(e=>{console.log("还书响应:",e),1===e.code||0===e.code?(b.nk.success(e.msg||"还书成功"),this.$nextTick(()=>{this.load()})):b.nk.error(e.msg||"还书失败")}).catch(e=>{console.error("还书失败:",e);const t=e.response?.data?.msg||e.message||"还书失败，请稍后重试";b.nk.error(t)})):b.nk.warning("缺少借阅记录ID")},handlelend(e){5!=this.number?0==this.numOfOutDataBook?this.user.id?e?(0,m.isUserInBlacklist)(this.user.id).then(t=>{t?b.nk.error("您已被列入黑名单，无法借书！"):(console.log("借书参数:",{userId:this.user.id,bookId:e}),h.A.post("/borrow",{userId:Number(this.user.id),bookId:Number(e)}).then(e=>{console.log("借书响应:",e),1===e.code||0===e.code?(b.nk.success(e.msg||"借阅成功"),this.$nextTick(()=>{this.load()})):b.nk.error(e.msg||"借阅失败")}).catch(e=>{console.error("借阅失败:",e);const t=e.response?.data?.msg||e.message||"借阅失败，请稍后重试";b.nk.error(t)}))}):b.nk.error("图书信息异常"):b.nk.error("用户信息异常，请重新登录"):b.nk.warning("在您归还逾期书籍前不能再借阅书籍"):b.nk.warning("您不能再借阅更多的书籍了")},add(){this.dialogVisible=!0,this.form={available_qty:0}},save(){if(this.useMock){if(this.form.id){const e=k.findIndex(e=>e.id===this.form.id);-1!==e?(k.splice(e,1,{...k[e],...this.form}),b.nk.success("修改书籍信息成功（本地模拟）")):b.nk.error("未找到该图书（本地模拟）")}else{const e=k.reduce((e,t)=>Math.max(e,t.id),0),t={...this.form,id:e+1};k.push(t),b.nk.success("上架书籍成功（本地模拟）")}this.$nextTick(()=>{this.load(),this.dialogVisible=!1,this.dialogVisible2=!1})}else this.form.id?h.A.post("/updateBook",{id:this.form.id,available_qty:this.form.available_qty}).then(e=>{console.log(e),1===e.code||0===e.code?(0,b.nk)({message:e.msg||"修改书籍信息成功",type:"success"}):b.nk.error(e.msg||"修改书籍信息失败"),this.$nextTick(()=>{this.load(),this.dialogVisible2=!1})}):h.A.post("/addBook",{title:this.form.title,author:this.form.author,available_qty:this.form.available_qty}).then(e=>{console.log(e),1===e.code||0===e.code?b.nk.success(e.msg||"上架书籍成功"):b.nk.error(e.msg||"上架书籍失败"),this.$nextTick(()=>{this.load(),this.dialogVisible=!1})})},handleEdit(e){this.form=JSON.parse(JSON.stringify(e)),this.dialogVisible2=!0},handleSizeChange(e){this.pageSize=e,this.load()},handleCurrentChange(e){this.currentPage=e,this.$nextTick(()=>{this.load()})},toLook(){this.dialogVisible3=!0}},data(){return{form:{},form2:{},form3:{},dialogVisible:!1,dialogVisible2:!1,search1:"",search2:"",search3:"",total:10,currentPage:1,pageSize:5,tableData:[],user:{},number:0,bookData:[],isbnArray:[],outDateBook:[],numOfOutDataBook:0,dialogVisible3:!0,useMock:!1}}},f=l(1241);const p=(0,f.A)(g,[["render",c]]);var y=p},5406:function(e,t,l){l.d(t,{isUserInBlacklist:function(){return a}});var o=l(5067);async function a(e){if(!e)return!1;try{const t=await o.A.get(`/blacklist/user/${e}/details`);return!!(t&&1===t.code&&t.data&&Array.isArray(t.data)&&t.data.length>0)}catch(t){return!1}}}}]);
//# sourceMappingURL=759.14b3a669.js.map